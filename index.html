<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Top Heroes Rush Event Calculator</title>
  <style>
    body {
      background-color: #1a172b;
      color: #ffd449;
      font-family: 'Arial Rounded MT Bold', sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      font-size: 2.5rem;
      margin-top: 1rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    h2 {
      font-size: 1.8rem;
      margin: 1.5rem 0;
    }
    table {
      margin: 1rem auto;
      border-collapse: collapse;
      width: 80%;
      max-width: 800px;
      background-color: #2a2740;
      color: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    th, td {
      padding: 1rem;
      font-size: 1.2rem;
      text-align: center;
    }
    th {
      background-color: #38355c;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background-color: rgba(255,255,255,0.05);
    }
    input[type=number] {
      width: 80px;
      padding: 8px;
      font-size: 1.1rem;
      border: 2px solid #38355c;
      border-radius: 5px;
      background-color: #1a172b;
      color: #ffd449;
      text-align: center;
    }
    input[type=number]:focus {
      outline: none;
      border-color: #64ff64;
    }
    input[type=text] {
      padding: 12px 16px;
      font-size: 1.2rem;
      border: 2px solid #38355c;
      border-radius: 8px;
      background-color: #2a2740;
      color: #fff;
      margin: 10px;
      width: 200px;
    }
    input[type=text]:focus {
      outline: none;
      border-color: #64ff64;
    }
    .btn {
      background-color: #64ff64;
      border: none;
      padding: 12px 24px;
      margin: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      border-radius: 10px;
      color: #1a172b;
      transition: all 0.3s ease;
      min-width: 200px;
    }
    .btn:hover {
      background-color: #50e050;
      transform: translateY(-2px);
    }
    .btn:disabled {
      background-color: #666;
      cursor: not-allowed;
      transform: none;
    }
    .progress {
      background-color: #333;
      border-radius: 10px;
      width: 80%;
      max-width: 600px;
      margin: 1rem auto;
      height: 30px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
    }
    .bar {
      background: linear-gradient(90deg, #64ff64, #32dd32);
      height: 100%;
      border-radius: 10px 0 0 10px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1a172b;
      font-weight: bold;
    }
    #rankingTable {
      margin-top: 2rem;
      width: 60%;
      max-width: 500px;
    }
    .total-score {
      font-size: 2rem;
      font-weight: bold;
      color: #64ff64;
      text-shadow: 0 0 10px rgba(100,255,100,0.5);
      margin: 20px 0;
    }
    .score-display {
      color: #64ff64;
      font-weight: bold;
    }
    .error-message {
      color: #ff6464;
      background-color: rgba(255,100,100,0.1);
      padding: 10px;
      border-radius: 5px;
      margin: 10px auto;
      max-width: 500px;
      display: none;
    }
    .success-message {
      color: #64ff64;
      background-color: rgba(100,255,100,0.1);
      padding: 10px;
      border-radius: 5px;
      margin: 10px auto;
      max-width: 500px;
      display: none;
    }
    @media (max-width: 768px) {
      table {
        width: 95%;
      }
      th, td {
        padding: 0.5rem;
        font-size: 1rem;
      }
      h1 {
        font-size: 2rem;
      }
      input[type=number] {
        width: 60px;
      }
    }
  </style>
</head>
<body>
  <h1>üèÜ Top Heroes Rush Event Calculator üèÜ</h1>

  <table>
    <thead>
      <tr>
        <th>Resource</th>
        <th>Pts/Unit</th>
        <th>What you have</th>
        <th>You'll get</th>
      </tr>
    </thead>
    <tbody id="resources">
      <tr>
        <td>üìñ Skill Books (x10)</td>
        <td>1</td>
        <td><input type="number" id="skill" value="0" min="0" onchange="updateScore()"></td>
        <td class="score-display" id="score_skill">0</td>
      </tr>
      <tr>
        <td>üçº Pet Food (x100)</td>
        <td>15</td>
        <td><input type="number" id="pet" value="0" min="0" onchange="updateScore()"></td>
        <td class="score-display" id="score_pet">0</td>
      </tr>
      <tr>
        <td>ü™ô Use Uncommon Pet</td>
        <td>150</td>
        <td><input type="number" id="unco" value="0" min="0" onchange="updateScore()"></td>
        <td class="score-display" id="score_unco">0</td>
      </tr>
      <tr>
        <td>ü™ö Use Rare Pet</td>
        <td>900</td>
        <td><input type="number" id="rare" value="0" min="0" onchange="updateScore()"></td>
        <td class="score-display" id="score_rare">0</td>
      </tr>
    </tbody>
  </table>

  <div class="total-score">Total Points: <span id="total">0</span> / 40,000</div>
  <div class="progress">
    <div class="bar" id="progressBar" style="width: 0%">
      <span id="progressText">0%</span>
    </div>
  </div>

  <div class="error-message" id="errorMessage"></div>
  <div class="success-message" id="successMessage"></div>

  <form id="scoreForm" onsubmit="submitScore(event)">
    <input type="text" id="pseudo" placeholder="Entrez votre pseudo" required maxlength="20">
    <br>
    <button class="btn" type="submit" id="submitBtn">Envoyer mon score</button>
  </form>

  <h2>üèÜ Classement en direct</h2>
  <table id="rankingTable">
    <thead>
      <tr>
        <th>Pseudo</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody id="ranking">
      <tr><td colspan="2">Chargement...</td></tr>
    </tbody>
  </table>

  <script>
    // URLs configur√©es
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbznq4hBT4z7wn2NA5rAlvZWOMIfRfMf9Za7S3YIXBZUz3Q3b89mkYngwtU5wvvVq_04sw/exec";
    const GOOGLE_SHEET_ID = "1iCrVEcqdJfa6xssi5wcB6p6DVP6USv4hYaP8Wl5SQcQ";

    function updateScore() {
      const skill = Math.floor(parseInt(document.getElementById("skill").value || 0) / 10);
      const pet = Math.floor(parseInt(document.getElementById("pet").value || 0) / 100) * 15;
      const unco = parseInt(document.getElementById("unco").value || 0) * 150;
      const rare = parseInt(document.getElementById("rare").value || 0) * 900;
      const total = skill + pet + unco + rare;

      document.getElementById("score_skill").textContent = skill.toLocaleString();
      document.getElementById("score_pet").textContent = pet.toLocaleString();
      document.getElementById("score_unco").textContent = unco.toLocaleString();
      document.getElementById("score_rare").textContent = rare.toLocaleString();
      document.getElementById("total").textContent = total.toLocaleString();
      
      const percentage = Math.min((total / 40000 * 100), 100);
      document.getElementById("progressBar").style.width = percentage + "%";
      document.getElementById("progressText").textContent = Math.round(percentage) + "%";
    }

    function showMessage(message, isError = false) {
      const errorDiv = document.getElementById("errorMessage");
      const successDiv = document.getElementById("successMessage");
      
      if (isError) {
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        successDiv.style.display = "none";
      } else {
        successDiv.textContent = message;
        successDiv.style.display = "block";
        errorDiv.style.display = "none";
      }
      
      // Masquer le message apr√®s 5 secondes
      setTimeout(() => {
        errorDiv.style.display = "none";
        successDiv.style.display = "none";
      }, 5000);
    }

    async function loadRanking() {
      try {
        console.log("Chargement du classement...");
        
        const res = await fetch(`https://opensheet.elk.sh/${GOOGLE_SHEET_ID}/Ranking`);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        console.log("Donn√©es re√ßues:", data);

        if (!Array.isArray(data)) {
          console.error("Les donn√©es re√ßues ne sont pas un tableau:", data);
          return;
        }

        // Filtre les lignes vides et trie par score
        const validData = data.filter(row => row.Pseudo && row.Score && !isNaN(parseInt(row.Score)));
        validData.sort((a, b) => parseInt(b.Score) - parseInt(a.Score));

        const table = document.getElementById("ranking");
        table.innerHTML = "";

        if (validData.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="2">Aucun score pour le moment</td>`;
          table.appendChild(tr);
          return;
        }

        validData.forEach((row, index) => {
          const tr = document.createElement("tr");
          const rank = index + 1;
          let rankEmoji = "";
          if (rank === 1) rankEmoji = "ü•á ";
          else if (rank === 2) rankEmoji = "ü•à ";
          else if (rank === 3) rankEmoji = "ü•â ";
          
          tr.innerHTML = `<td>${rankEmoji}${row.Pseudo}</td><td>${parseInt(row.Score).toLocaleString()}</td>`;
          table.appendChild(tr);
        });

      } catch (error) {
        console.error("Erreur lors du chargement du classement:", error);
        const table = document.getElementById("ranking");
        table.innerHTML = `<tr><td colspan="2">Erreur de chargement</td></tr>`;
      }
    }

    async function submitScore(e) {
      e.preventDefault();

      const pseudo = document.getElementById("pseudo").value.trim();
      const score = parseInt(document.getElementById("total").textContent.replace(/,/g, ''));

      // Validation
      if (!pseudo) {
        showMessage("Merci de saisir un pseudo !", true);
        return;
      }

      if (pseudo.length < 2) {
        showMessage("Le pseudo doit faire au moins 2 caract√®res !", true);
        return;
      }

      if (score === 0) {
        if (!confirm("Votre score est de 0, √™tes-vous s√ªr de vouloir l'envoyer ?")) {
          return;
        }
      }

      // D√©sactive le bouton pendant l'envoi
      const submitBtn = document.getElementById("submitBtn");
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = "Envoi en cours...";

      try {
        console.log("Envoi du score:", { pseudo, score });

        // Utilisation d'un formulaire cach√© pour contourner CORS
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = GOOGLE_SCRIPT_URL;
        form.target = '_blank';
        form.style.display = 'none';

        const pseudoInput = document.createElement('input');
        pseudoInput.type = 'hidden';
        pseudoInput.name = 'pseudo';
        pseudoInput.value = pseudo;

        const scoreInput = document.createElement('input');
        scoreInput.type = 'hidden';
        scoreInput.name = 'score';
        scoreInput.value = score;

        form.appendChild(pseudoInput);
        form.appendChild(scoreInput);
        document.body.appendChild(form);

        // Alternative: JSONP-like approach
        const scriptUrl = `${GOOGLE_SCRIPT_URL}?callback=handleResponse&pseudo=${encodeURIComponent(pseudo)}&score=${score}`;
        
        // Cr√©er un script tag pour contourner CORS
        const script = document.createElement('script');
        script.src = scriptUrl;
        
        // Fonction de callback globale
        window.handleResponse = function(data) {
          console.log("R√©ponse re√ßue:", data);
          if (data && data.result === "success") {
            showMessage("‚úÖ Score envoy√© avec succ√®s !");
            document.getElementById("scoreForm").reset();
            updateScore();
            setTimeout(loadRanking, 2000); // Recharge apr√®s 2 secondes
          } else {
            showMessage("‚ùå Erreur: " + (data?.message || "Erreur inconnue"), true);
          }
          document.body.removeChild(script);
          delete window.handleResponse;
        };

        document.body.appendChild(script);

        // Si pas de r√©ponse apr√®s 10 secondes, on assume que c'est envoy√©
        setTimeout(() => {
          if (window.handleResponse) {
            showMessage("üì§ Score probablement envoy√© ! V√©rifiez le classement dans quelques secondes.");
            setTimeout(loadRanking, 3000);
            delete window.handleResponse;
            if (document.body.contains(script)) {
              document.body.removeChild(script);
            }
          }
        }, 10000);

      } catch (err) {
        console.error("Erreur compl√®te:", err);
        showMessage("‚ùå Erreur de connexion. V√©rifiez votre connexion internet.", true);
      } finally {
        // R√©active le bouton
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }

    // Initialisation
    updateScore();
    loadRanking();
    
    // Recharge le classement toutes les 30 secondes
    setInterval(loadRanking, 30000);

    // Sauvegarde automatique des valeurs dans le navigateur
    function saveToLocalStorage() {
      const data = {
        skill: document.getElementById("skill").value,
        pet: document.getElementById("pet").value,
        unco: document.getElementById("unco").value,
        rare: document.getElementById("rare").value,
        pseudo: document.getElementById("pseudo").value
      };
      localStorage.setItem('heroesRushData', JSON.stringify(data));
    }

    function loadFromLocalStorage() {
      const data = localStorage.getItem('heroesRushData');
      if (data) {
        const parsed = JSON.parse(data);
        document.getElementById("skill").value = parsed.skill || 0;
        document.getElementById("pet").value = parsed.pet || 0;
        document.getElementById("unco").value = parsed.unco || 0;
        document.getElementById("rare").value = parsed.rare || 0;
        document.getElementById("pseudo").value = parsed.pseudo || '';
        updateScore();
      }
    }

    // Charge les donn√©es sauvegard√©es au d√©marrage
    loadFromLocalStorage();

    // Sauvegarde √† chaque modification
    document.querySelectorAll('input').forEach(input => {
      input.addEventListener('input', saveToLocalStorage);
    });
  </script>
</body>
</html>
